<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
</head>
<body>
<h1>Login and Connect to WebSocket</h1>
<form id="loginForm">
    <label for="username">Username:</label>
    <input type="text" id="username" value="testuser" required>
    <br>
    <label for="password">Password:</label>
    <input type="password" id="password" value="password123" required>
    <br>
    <button type="submit">Login</button>
</form>
<p id="message"></p>

<hr>

<h2>Exchange Test</h2>
<div id="exchangeSection" style="display: none;">
    <h3>List an Item</h3>
    <form id="listItemForm">
        <label for="itemName">Item Name:</label>
        <input type="text" id="itemName" required>
        <br>
        <label for="price">Price:</label>
        <input type="number" id="price" required>
        <br>
        <button type="submit">List Item</button>
    </form>

    <h3>Available Items</h3>
    <button id="refreshItemsButton">Refresh Items</button>
    <ul id="availableItems"></ul>
</div>

<script>
    let socket;
    let reconnectInterval = 5000; // 5 seconds
    let token;

    function connectWebSocket(token) {
        socket = new WebSocket("ws://localhost:3000/ws", ["Authorization", token]);

        socket.onopen = () => {
            console.log('WebSocket connection opened');
        };

        socket.onmessage = (event) => {
            console.log('Message from server:', event.data);
        };

        socket.onclose = () => {
            console.log('WebSocket connection closed. Reconnecting in 5 seconds...');
            setTimeout(() => {
                connectWebSocket(token);
            }, reconnectInterval);
        };

        socket.onerror = (error) => {
            console.error('WebSocket error:', error);
        };
    }

    document.getElementById('loginForm').addEventListener('submit', async (event) => {
        event.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch('http://localhost:3000/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (!response.ok) throw new Error('Failed to authenticate');

            const data = await response.json();
            token = data.token;

            connectWebSocket(token);

            // Show the exchange section after successful login
            document.getElementById('exchangeSection').style.display = 'block';

        } catch (error) {
            console.error('Error:', error);
        }
    });

    document.getElementById('listItemForm').addEventListener('submit', async (event) => {
        event.preventDefault();

        const itemName = document.getElementById('itemName').value;
        const price = document.getElementById('price').value;

        try {
            const response = await fetch('http://localhost:3000/api/exchange/listItem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ itemName, price })
            });

            if (!response.ok) throw new Error('Failed to list item');

            const data = await response.json();
            alert(`Item listed: ${data.itemName} for ${data.price} gold`);

        } catch (error) {
            console.error('Error listing item:', error);
        }
    });

    document.getElementById('refreshItemsButton').addEventListener('click', async () => {
        try {
            const response = await fetch('http://localhost:3000/api/exchange/getItems', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (!response.ok) throw new Error('Failed to fetch items');

            const items = await response.json();
            console.log(items)
            const itemsList = document.getElementById('availableItems');
            itemsList.innerHTML = ''; // Clear the list

            items.forEach(item => {
                const listItem = document.createElement('li');
                listItem.textContent = `${item.itemName} - ${item.price} gold`;
                itemsList.appendChild(listItem);
            });

        } catch (error) {
            console.error('Error fetching items:', error);
        }
    });
</script>
</body>
</html>
